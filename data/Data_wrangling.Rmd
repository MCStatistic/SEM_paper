---
title: "Untitled"
author: "Marlon Schumacher"
date: "18 8 2018"
output: pdf_document
---

# packages
```{r}
install.packages("pacman")
library("pacman")
p_load(tidyverse, # noting to explain, makes it just tidy
       haven, # read-function and more
       magrittr, 
       corrplot, 
       mvnmle, 
       mice, 
       tidyr, 
       dplyr, # data wrangling & pipe-operator
       semPlot,
       lavaan) # for plotting models

## Packages will be
```

#Input: ALLBUS 2016
```{r}
allbus_oD <- read_spss("allbus2016.sav") %>% 
  select(age, sex, work, mp02, mp04, mp06, mp07, mp09, mp11, 
         mc04, isced11, siops08, di08c, id02, wghtpew)

allbus <- read_spss("allbus2016.sav") %>% 
  select(age, sex, work, ma09, mp02, mp03, mp04, mp05, mp06, mp07, mp08, mp09, mp10, mp11, mp12, 
         mc01, mc02, mc03, mc04, mc09, dn07, ma02, ma03, ma04, 
         pn01, pn02, pn03, pn04, pn05, pn06, pn07, ma09, ingle, id02,
         isced11, siops08, di08c, xr27, wghtpew)

# View(allbus_oD)

# ncol(allbus)
# nrow(allbus)

```


##soziodemografische Werte
age
sex
isced11: Bildung
siops08: Berufsprestige
di08c:   Äquivalenzeinkommen, kat.
xr27:    Schichteinstufung - Haushalt (VOR Beginn des Interview)
id02:    Schichteinstufung - Haushalt 

##Einstellung zu Ausländern
mp02 - Soziales Netz
mp04 - Wohnungen
mp06 - Arbeitsplätze
mp07 - Straftaten
mp09 - Zusammenhalt
mp11 - Schulniveau

##Kontakt/Kontakterfahrung
mc04 (Kontakt im Freundeskreis), 
mc09 (Wie oft gute Erfahrungen mit Kontakt gemacht?)
mc01, mc02, mc03 -> entfällt, da Faktorladungen zu schlecht
mc10 -> entfällt, da bereits mc09 verwendet wird...

##Stolz -> entfällt, da zu viel
pn01, pn02, pn03, pn04, pn05, pn06, pn07


#Missing Data - percentage & first look
```{r, results='asis'}
# colMeans(is.na(allbus))
# 
# mis_p <- allbus %>%
#   summarize_all(funs(sum(is.na(.)) / length(.)))

# install.packages("naniar")
library("naniar") # Package for missing analysis
library(ggplot2)
# gg_miss_var(allbus, show_pct = T) + labs(y = "Missing Data") + ylim(0, 60)

# creating percantage of missing data
missing_oD <- allbus_oD %>%
  miss_var_summary() %>% 
  select(-n_miss_cumsum, -n_miss)

missing_oD <- missing_oD[!(missing_oD$variable == "sex"),]
missing_oD <- missing_oD[!(missing_oD$variable == "work"),]
missing_oD <- missing_oD[!(missing_oD$variable == "age"),]
missing_oD <- missing_oD[!(missing_oD$variable == "wghtpew"),]
missing_oD <- missing_oD[!(missing_oD$variable == "siops08_mis"),]

missing_oD$variable

rownames_mis_oD <- c("Berufsprestige","Äquivalenzeink.", "Kontakt", "A_Straftaten", "A_Schulniveau",
                     "A_Wohnungen", "Schicht", "A_Zusammenhalt", "A_Soziales_Netz", "A_Arbeitsplätze",
                     "Bildung")

missing_oD$variable <- rownames_mis_oD

# Plot of Percentage of Missing Values for each Variable
ggplot(data=missing_oD, aes(x= reorder(variable,pct_miss), 
                         y=pct_miss,
                         label=pct_miss)) +
  labs(x = " ", y = " ") +
  geom_bar(stat="identity", fill = "skyblue4") + 
  geom_text(label=format(missing_oD$pct_miss, digits=2),
            size = 3,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) + 
  coord_flip() +
  theme(axis.text.y = element_text(angle = 40, vjust = 1, hjust=1)) +
  ggtitle(expression(paste(bold("Abbildung 1: "), "Prozente der fehlenden Werte")))

# Missing Mechanism
allbus_mis <- as.data.frame(md.pattern(allbus_oD, plot = F))

allbus_mis2 <- allbus_mis[!(allbus_mis$siops08 > 1),]
# View(allbus_mis2)

allbus_oD <- transform(allbus_oD, siops08_mis = ifelse(is.na(siops08), 0, 1))
allbus_oD

options(scipen =999)
# install.packages("ISLR")
library("ISLR") # package for logistic regression
glm.fit1 <- glm(siops08_mis ~ work + age + di08c, 
                data = allbus_oD, 
                family = binomial)

summary(glm.fit1)

install.packages("stargazer")
library(stargazer)
stargazer(glm.fit1)

# high significant correlation between work and missings of siops08
# should filtering data set by work

# creating new df by filtering with work == 4 (not working) & 3
allbus_c <- allbus_oD[!(allbus_oD$work == 4),]
allbus_c <- allbus_c[!(allbus_c$work == 3),]
# deleting the row with one new NA in it...look up where it come from...confusing.
allbus_c <- allbus_c[!(is.na(allbus_c$sex)),]

# creating percantage of missing data
missing_c <- allbus_c %>%
  miss_var_summary() %>% 
  select(-n_miss_cumsum)

missing_c <- missing_c[!(missing_c$variable == "wghtpew"),]
missing_c <- missing_c[!(missing_c$variable == "siops08_mis"),]
missing_c <- missing_c[!(missing_c$variable == "age"),]
missing_c <- missing_c[!(missing_c$variable == "sex"),]
missing_c <- missing_c[!(missing_c$variable == "work"),]

colnames(missing_c)  

rownames_mis_p <- c("Äquivalenzeink.", "Kontakt", "A_Straftaten", "Berufsprestige", "A_Wohnungen",
              "A_Schulniveau", "A_Zusammenhalt", "Schicht", "A_Soziales_Netz", "A_Arbeitsplätze",
              "Bildung")

missing_c$variable <- rownames_mis_p

# Plot of Percentage of Missing Values for each Variable
ggplot(data=missing_c, aes(x= reorder(variable,pct_miss), 
                         y=pct_miss,
                         label=pct_miss)) +
  labs(x = " ", y = " ") +
  geom_bar(stat="identity", fill = "skyblue4") + 
  geom_text(label=format(missing_c$pct_miss, digits=2),
            size = 3,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) + 
  coord_flip() +
  theme(axis.text.y = element_text(angle = 40, vjust = 1, hjust=1)) +
  ylab("Anteil in Prozent") +
  ggtitle(expression(paste(bold("Abbildung 2: "), "Prozente der fehlenden Werte nach Filterung")))

  
missing_c_col <- setnames(data, old=c("old_name","another_old_name"), new=c("new_name", "another_new_name"))
```


#Missing Data - testing mechanism
```{r}
# install.packages("BaylorEdPsych")
library(BaylorEdPsych) # package for LittleMCAR

LittleMCAR(allbus_c)
# chisq: 3513.059
# df: 1191
# pvalue: 0.000
# H0-Hypothese wird folglich verworfen -> KEIN MCAR!


# Logistic Regression for di08c-missings
allbus_c <- transform(allbus_c, di08c_mis = ifelse(is.na(di08c), 0, 1))
glm_mis2 <- glm(di08c_mis ~ sex + age + isced11, 
                data = allbus_c, 
                family = binomial)
summary(glm_mis2)
stargazer(glm.fit1, glm_mis2, glm_mis3, title = "Tabelle x: logisitische Regression - Fehlende Werte")

# Schichteinstufung (negativ) & Alter (positiv) haben hier einen signifikanten Einfluss

# Logistic Regression for mc09-missings
allbus_c <- transform(allbus_c, mc09_mis = ifelse(is.na(mc09), 0, 1))
glm_mis3 <- glm(mc09_mis ~ sex + age + work + id02 + isced11 + mc04, 
                data = allbus_c, 
                family = binomial)
summary(glm_mis3)

# Kontakt Freundeskreis (negativ) hat hoch sig. negativen Zusammenhang! 
# Grund: Man kann auf einen fehlenden Kontakt schließen, wodurch eine Beantwortung der Erfahrung ausbleibt

# Entscheidung für Missing at Random (MAR)

```


#Missing Data - multiple imputation
```{r}
install.packages("mice")
library(mice)

# Deleting variables for logistic regressions
allbus_c2 <- allbus_c %>% 
  select(-siops08_mis,
         -di08c_mis)

allb_imp <- mice(allbus_c2, 
                   m=5,           # Number of multiple imputations
                   maxit=20,      # Number of iterations taken to impute missings
                   method="pmm",  # method = predictive mean matching
                   seed=500)      # 

# Inspecting Imputation
allb_vis <- allbus_c2
colnames(allb_vis)<- c("Alter", "Geschlecht", "Arbeitssituation", "A_Soziales_Netz", 
                        "A_Wohnungen", "A_Arbeitsplätze", "A_Straftaten", "A_Zusammenhalt",
                        "A_Schulniveau", "Kontakt", "Bildung", "Berufsprestige", "Äquivalenzeink.",
                        "Schicht", "Gewichtung")

allb_imp_vis <- mice(allb_vis,
                     m = 5,
                     maxit = 20,
                     method = "pmm",
                     seed=500)

densityplot(allb_imp_vis)
stripplot(allb_imp_vis)
densityplot(allb_imp)
stripplot(allb_imp)

imp <- allb_imp
colnames(imp$imp)[which(names(imp$imp) == "mp02")] <- "Klappts"

densityplot(allb_imp, ylab = "Density")
stripplot(allb_imp)

densityplot(imp)

allbus_imp <- complete(allb_imp)
allbus_imp

```

#Descritptive Analysis
```{r}
m_test <- allbus_imp %>% 
  select(-wghtpew, -sex, -age, -work)

install.packages("pastecs")
library(pastecs)

stat.desc(m_test)

summary(m_test)


install.packages("MVN") # Package for Mardia Test
library(mvn)

mvn(m_test, 
    mvnTest = "hz",
    cov = T,
    multivariatePlot = "qq")

mvn(m_test, 
    mvnTest = "royston",
    covariance = T,
    multivariatePlot = "qq")

results <- mvn(m_test, 
    mvnTest = "mardia",
    covariance = T,
    multivariatePlot = "qq")

mardia(m_test)

# Mardia Skewness ist extrem hoch, leider derzeit noch keine wirkliche Literatur diesbezüglich gefunden

desc <- as.data.frame(results$Descriptives)
desc_sw <- as.data.frame(results$univariateNormality)
desc_sw <- desc_sw %>% 
  select(-Test, -Normality)

desc_complete <- cbind(desc, desc_sw)

desc <- desc %>% 
  select(-n, -"25th", -"75th")

table(desc)
stargazer(desc)

# creating latex-code for descriptive Table
desc_x <- desc 
library(xtable)
xtable(desc_x)

desc_comp <- desc_complete %>% 
  select(-variable, - Variable, -Statistic)

# ordering colnames
col_order <- c("Mean", "Median", "Std.Dev", "Min", "Max", "Skew", "Kurtosis", "p value")
desc_complete_f <- desc_comp[, col_order]

desc_co_f<- desc_complete_f %>% 
  select(-Min, -Max)

xtable(desc_complete_f)
xtable(desc_complete)

stargazer(desc_comp)
```

# Correlation & More
```{r}
allb_vis_cor <- allbus_imp %>% 
  select(-age, -sex, -wghtpew, -work)

# creating correlation matrix
res <- cor(allb_vis_cor)
res <- round(res, 2)

as.data.frame(res)
# latex code for table
xtable(as.data.frame(res))

allb_vis_p <- allb_vis_cor
colnames(allb_vis_p) <- c("A_Soz.",  "A_Wohnungen", "A_Arbeitsplätze", "A_Straftaten",
                          "A_Zusammenhalt", "A_Schulniveau", "Kontakt", "Bildung", "Berufsprestige",
                          "Äquivalenzeink.","Schicht")
res_p <- cor(allb_vis_p)
res_p <- round(res_p, 2)

# Plot
library(corrplot)
corrplot(res_p, method = "square", # Darstellungsmethode
         type = "upper", # 
         tl.col="black", # color of labels
         tl.srt = 15, # winkel der labels
         tl.cex = 0.6, # size of labels
         addCoef.col="black", # color for coef
         diag=FALSE, # diagonale wird so nicht dargestellt
         insig = "blank")
```

# Faktorenanalyse
```{r}
allb_efa <- allbus_imp %>% 
  select(-age, -sex, -wghtpew, -work, -mc04)

install.packages("GPArotation")
library(GPArotation)
fa_1 <- fa(allb_efa, 2, fm="pa", rotate ="oblimin")
```


#Saving Data RData
```{r}
save(allbus_imp, 
     file = "/Users/marlonschumacher/Documents/2_Master/Git_Projekte/SEM_paper/allbus_imp.RData")
```






