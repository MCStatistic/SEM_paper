---
title: "Untitled"
author: "Marlon Schumacher"
date: "18 8 2018"
output: pdf_document
---

# packages
```{r}
# install.packages("pacman")
library("pacman")
p_load(tidyverse, # noting to explain, makes it just tidy
       haven, # read-function and more
       magrittr, 
       corrplot, 
       mvnmle, 
       mice, 
       tidyr, 
       dplyr, # data wrangling & pipe-operator
       semPlot,
       lavaan) # for plotting models

## Packages will be
```

#Input: ALLBUS 2016
```{r}
allbus_oD <- read_spss("allbus2016.sav") %>% 
  select(age, sex, work, mp01, mp02, mp03, mp04, mp06, mp07, mp09, mp11, 
         mc04, mc09, isced11, siops08, di08c, id02, wghtpew)

allbus <- read_spss("allbus2016.sav") %>% 
  select(age, sex, work, ma09, mp02, mp03, mp04, mp05, mp06, mp07, mp08, mp09, mp10, mp11, mp12, 
         mc01, mc02, mc03, mc04, mc09, dn07, ma02, ma03, ma04, 
         pn01, pn02, pn03, pn04, pn05, pn06, pn07, ma09, ingle, id02,
         isced11, siops08, di08c, xr27, wghtpew)

# View(allbus_oD)

# ncol(allbus)
# nrow(allbus)

```


##soziodemografische Werte
age
sex
isced11: Bildung
siops08: Berufsprestige
di08c:   Äquivalenzeinkommen, kat.
xr27:    Schichteinstufung - Haushalt (VOR Beginn des Interview)
id02:    Schichteinstufung - Haushalt 

##Einstellung zu Ausländern
mp01, mp02, mp03, mp04, mp05, mp06, mp07, mp08, mp09, mp10, mp11, mp12

##Kontakt/Kontakterfahrung
mc04 (Kontakt im Freundeskreis), 
mc09 (Wie oft gute Erfahrungen mit Kontakt gemacht?)
mc01, mc02, mc03 -> entfällt, da Faktorladungen zu schlecht
mc10 -> entfällt, da bereits mc09 verwendet wird...

##Stolz -> entfällt, da zu viel
pn01, pn02, pn03, pn04, pn05, pn06, pn07


#Missing Data - percentage & first look
```{r, results='asis'}
# colMeans(is.na(allbus))
# 
# mis_p <- allbus %>%
#   summarize_all(funs(sum(is.na(.)) / length(.)))

# install.packages("naniar")
library("naniar") # Package for missing analysis
library(ggplot2)
# gg_miss_var(allbus, show_pct = T) + labs(y = "Missing Data") + ylim(0, 60)

# creating percantage of missing data
missing_oD <- allbus_oD %>%
  miss_var_summary() %>% 
  select(-n_miss_cumsum, -n_miss)

# Plot of Percentage of Missing Values for each Variable
ggplot(data=missing_oD, aes(x= reorder(variable,pct_miss), 
                         y=pct_miss,
                         label=pct_miss)) +
  labs(x = " ", y = " ") +
  geom_bar(stat="identity", fill = "skyblue4") + 
  geom_text(label=format(missing_oD$pct_miss, digits=2),
            size = 3,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) + 
  coord_flip() +
  theme_gray() +
  ggtitle(expression(paste(bold("Abbildung 1: "), "Prozente der fehlenden Werte")))

# Missing Mechanism
allbus_mis <- as.data.frame(md.pattern(allbus_oD, plot = F))

allbus_mis2 <- allbus_mis[!(allbus_mis$siops08 > 1),]
# View(allbus_mis2)

allbus_oD <- transform(allbus_oD, siops08_mis = ifelse(is.na(siops08), 0, 1))
allbus_oD

# install.packages("ISLR")
library("ISLR") # package for logistic regression
glm.fit1 <- glm(siops08_mis ~ work + age + di08c, 
                data = allbus_oD, 
                family = binomial)

summary(glm.fit1)

# high significant correlation between work and missings of siops08
# should filtering data set by work

# creating new df by filtering with work == 4 (not working)
allbus_c <- allbus_oD[!(allbus_oD$work == 4),]
# deleting the row with one new NA in it...look up where it come from...confusing.
allbus_c <- allbus_c[!(is.na(allbus_c$sex)),]

# nrow(allbus_c)
# 
# View(allbus_c)

# creating percantage of missing data
missing_c <- allbus_c %>%
  miss_var_summary() %>% 
  select(-n_miss_cumsum)

missing_c <- missing_c[!(missing_c$variable == "wghtpew"),]
missing_c <- missing_c[!(missing_c$variable == "siops08_mis"),]

# Plot of Percentage of Missing Values for each Variable
ggplot(data=missing_c, aes(x= reorder(variable,pct_miss), 
                         y=pct_miss,
                         label=pct_miss)) +
  labs(x = " ", y = " ") +
  geom_bar(stat="identity", fill = "skyblue4") + 
  geom_text(label=format(missing_c$pct_miss, digits=2),
            size = 3,
            color=rgb(100,100,100, maxColorValue=255),
            hjust=-0.1) + 
  coord_flip() +
  theme_gray() +
  ggtitle(expression(paste(bold("Abbildung 2: "), "Prozente der fehlenden Werte nach Filterung")))
```


#Missing Data - testing mechanism
```{r}
# install.packages("BaylorEdPsych")
library(BaylorEdPsych) # package for LittleMCAR

LittleMCAR(allbus_c)
# chisq: 3959.322
# pvalue: 0.000
# H0-Hypothese wird folglich verworfen -> KEIN MCAR!

# Logistic Regression for siops08-missings
glm_mis1 <- glm(siops08_mis ~ sex + age + work + id02 + isced11, 
                data = allbus_c, 
                family = binomial)
summary(glm_mis1)

# Geschlecht & Work haben hier einen hoch sig. Einfluss.
# Kann darau fhindeuten, dass vor allem Teilzeit kein Prestige bekommt bzw. es nicht ermittelt werden kann

# Logistic Regression for di08c-missings
allbus_c <- transform(allbus_c, di08c_mis = ifelse(is.na(di08c), 0, 1))
glm_mis2 <- glm(di08c_mis ~ sex + age + work + id02 + isced11, 
                data = allbus_c, 
                family = binomial)
summary(glm_mis2)

# Schichteinstufung (negativ) & Alter (positiv) haben hier einen signifikanten Einfluss

# Logistic Regression for mc09-missings
allbus_c <- transform(allbus_c, mc09_mis = ifelse(is.na(mc09), 0, 1))
glm_mis3 <- glm(mc09_mis ~ sex + age + work + id02 + isced11 + mc04, 
                data = allbus_c, 
                family = binomial)
summary(glm_mis3)

# Kontakt Freundeskreis (negativ) hat hoch sig. negativen Zusammenhang! 
# Grund: Man kann auf einen fehlenden Kontakt schließen, wodurch eine Beantwortung der Erfahrung ausbleibt

# Entscheidung für Missing at Random (MAR)

```


#Missing Data - multiple imputation
```{r}
install.packages("mice")
library(mice)

# Deleting variables for logistic regressions
allbus_c2 <- allbus_c %>% 
  select(-siops08_mis,
         -di08c_mis,
         -mc09_mis)

allb_imp <- mice(allbus_c2, 
                   m=5,           # Number of multiple imputations
                   maxit=50,      # Number of iterations taken to impute missings
                   method="pmm",  # method = predictive mean matching
                   seed=500)      # 

allbus_imp <- complete(allb_imp)
allbus_imp

miss_var_summary(allbus_imp)
```


#Saving Data RData
```{r}
save(allbus_imp, 
     file = "/Users/marlonschumacher/Documents/2_Master/Git_Projekte/SEM_paper/allbus_imp.RData")
```


